<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <title>Песни</title>
    <link rel="stylesheet" href="search.css">
</head>
<body>
    <div class="container">
        <div class="header-nav">
            <a href="index.html" class="header-cell">А/Б/В</a>
            <a href="index_full.html" class="header-cell">А+Б+В</a>
            <div class="header-cell title-cell">
                <h1>Песни</h1>
            </div>
            <a href="today.html" class="header-cell">Сегодня</a>
            <a href="search.html" class="header-cell">
                <img src="search.png" alt="Поиск">
            </a>
        </div>
        
        <nav class="search-nav">
            <input type="text" id="searchBar" placeholder="Введите текст для поиска">
            <button id="searchButton">Искать</button>
        </nav>
        <div id="results"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/lunr/lunr.min.js"></script>
<script>
    let idx;
    let songsData;

    // Заменим стандартный tokenizer на более подходящий для русского языка
    lunr.tokenizer.separator = /[\s\.,!?«»"“”()\-—:;]+/;

    fetch('songs.json')
        .then(response => response.json())
        .then(data => {
            songsData = data;

            // Создание индекса
            idx = lunr(function () {
                this.ref('id');
                this.field('title');
                this.field('text');

                this.pipeline.remove(lunr.stemmer); // Удалить английский стеммер
                this.pipeline.remove(lunr.stopWordFilter); // Удалить английские стоп-слова

                data.forEach(song => {
                    this.add({
                        id: song.id,
                        title: song.title.toLowerCase(),
                        text: song.text.toLowerCase()
                    });
                });
            });

            // Слушатели
            document.getElementById('searchButton').addEventListener('click', performSearch);
            document.getElementById('searchBar').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        })
        .catch(error => {
            console.error("Ошибка загрузки songs.json:", error);
            document.getElementById('results').innerHTML = `
                <div class="error-message">
                    <p><strong>Ошибка загрузки данных:</strong> Не удалось загрузить список песен.</p>
                    <p>Это может быть вызвано ограничениями CORS при открытии файлов локально.</p>
                    <p>Рекомендуемое решение: запустите сайт через локальный веб-сервер.</p>
                </div>
            `;
        });

    function performSearch() {
        const queryInput = document.getElementById('searchBar').value.trim().toLowerCase();
        const resultContainer = document.getElementById('results');
        resultContainer.innerHTML = '';

        if (!idx) {
            resultContainer.innerHTML = '<p>Поиск недоступен. Индекс не инициализирован.</p>';
            return;
        }

        if (!queryInput) {
            resultContainer.innerHTML = '<p>Введите текст для поиска.</p>';
            return;
        }

        // Используем wildcard для начала слова
        const lunrResults = idx.search(queryInput + "*");

        if (lunrResults.length === 0) {
            resultContainer.innerHTML = '<p>Ничего не найдено.</p>';
            return;
        }

        lunrResults.forEach(result => {
            const song = songsData.find(song => String(song.id) === result.ref);
            if (song) {
                const songElement = document.createElement('div');
                songElement.innerHTML = `
                    <p><strong>${song.title}</strong><br>
                    <a href="${song.url}" target="_blank">Перейти к песне</a></p>
                `;
                resultContainer.appendChild(songElement);
            } else {
                resultContainer.innerHTML += '<p style="color:red;">Ошибка: песня не найдена.</p>';
            }
        });
    }
</script>
</body>
</html>
