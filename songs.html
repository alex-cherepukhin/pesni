<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <title>Песни</title>
    <link rel="stylesheet" href="CSS/index.css">
    <style>
        .filter-info {
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        
        .filter-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .filter-info-title {
            font-weight: 600;
            color: #1976D2;
        }
        
        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .filter-tag {
            background: white;
            border: 1px solid #2196F3;
            color: #1976D2;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
        }
        
        .btn-change-filter {
            background: #2196F3;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .btn-change-filter:hover {
            background: #1976D2;
        }
        
        @media (max-width: 600px) {
            .filter-info-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .btn-change-filter {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Навигация -->
        <div class="header-nav">
            <a href="index.html" class="header-cell">АБВ</a>
            <a href="index_full.html" class="header-cell">Все</a>
            <a href="topics.html" class="header-cell" id="topicsLink">Темы</a>
            <a href="today.html" class="header-cell">Сегодня</a>
            <a href="search.html" class="header-cell">
                <img src="search.png" alt="Поиск">
            </a>
        </div>
        
        <!-- Информация о фильтре -->
        <div class="filter-info" id="filterInfo" style="display: none;">
            <div class="filter-info-header">
                <div class="filter-info-title" id="filterTitle">Загрузка...</div>
                <button class="btn-change-filter" onclick="changeFilter()">Изменить фильтр</button>
            </div>
            <div class="filter-tags" id="filterTags"></div>
        </div>
        
        <!-- Алфавитная навигация -->
        <div class="alpha-nav" id="alphaNav"></div>
        
        <!-- Список песен по буквам -->
        <div id="songsContainer"></div>
    </div>

    <script>
        // Маппинг латинских букв в русские
        const LETTER_MAPPING = {
            'A': 'А',
            'B': 'Б',
            'V': 'В',
            'G': 'Г',
            'D': 'Д',
            'E': 'Е',
            'ZH': 'Ж',
            'Z': 'З',
            'I': 'И',
            'K': 'К',
            'L': 'Л',
            'M': 'М',
            'N': 'Н',
            'O': 'О',
            'P': 'П',
            'R': 'Р',
            'S': 'С',
            'T': 'Т',
            'TS': 'Ц',
            'U': 'У',
            'F': 'Ф',
            'H': 'Х',
            'CH': 'Ч',
            'SH': 'Ш',
            'SCH': 'Щ',
            'Y': 'Ы',
            'JE': 'Э',
            'JU': 'Ю',
            'JA': 'Я'
        };
        
        // Порядок русских букв для сортировки
        const RUSSIAN_ALPHABET = 'АБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЫЭЮЯ'.split('');
        
        let topics = {};
        let songs = [];
        let selectedTopics = [];
        
        // Загрузка данных
        async function loadData() {
            try {
                const [topicsResponse, songsResponse] = await Promise.all([
                    fetch('topics.json'),
                    fetch('songs_all.json')
                ]);
                
                topics = await topicsResponse.json();
                songs = await songsResponse.json();
                
                // Получаем фильтр из URL
                const urlParams = new URLSearchParams(window.location.search);
                const topicsParam = urlParams.get('topics');
                
                if (topicsParam) {
                    selectedTopics = topicsParam.split(',');
                    displayFilterInfo();
                    
                    // Обновляем ссылку "Темы" в навигации
                    const topicsLink = document.getElementById('topicsLink');
                    topicsLink.href = `topics.html?topics=${selectedTopics.join(',')}`;
                }
                
                displaySongs();
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                document.getElementById('songsContainer').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: #999;">Ошибка загрузки данных</div>';
            }
        }
        
        // Отображение информации о фильтре
        function displayFilterInfo() {
            const filterInfo = document.getElementById('filterInfo');
            const filterTitle = document.getElementById('filterTitle');
            const filterTags = document.getElementById('filterTags');
            
            if (selectedTopics.length > 0) {
                filterInfo.style.display = 'block';
                
                // Подсчитываем количество песен
                const filteredSongs = songs.filter(song => 
                    selectedTopics.includes(song.topic || '')
                );
                
                // Заголовок с количеством
                filterTitle.textContent = `Найдено: ${filteredSongs.length}. Активные фильтры:`;
                
                // Создаём теги для каждой выбранной темы
                filterTags.innerHTML = '';
                selectedTopics.forEach(topicAlias => {
                    const tag = document.createElement('span');
                    tag.className = 'filter-tag';
                    
                    if (topicAlias === '') {
                        tag.textContent = '(без темы)';
                    } else if (topics[topicAlias]) {
                        tag.textContent = topics[topicAlias].name;
                    } else {
                        tag.textContent = topicAlias;
                    }
                    
                    filterTags.appendChild(tag);
                });
            }
        }
        
        // Изменить фильтр - возврат на страницу выбора тем
        function changeFilter() {
            window.location.href = `topics.html?topics=${selectedTopics.join(',')}`;
        }
        
        // Конвертация латинской буквы в русскую
        function latinToRussian(latin) {
            return LETTER_MAPPING[latin] || latin;
        }
        
        // Отображение списка песен
        function displaySongs() {
            // Фильтруем песни
            let filteredSongs;
            if (selectedTopics.length === 0) {
                filteredSongs = songs;
            } else {
                filteredSongs = songs.filter(song => 
                    selectedTopics.includes(song.topic || '')
                );
            }
            
            const count = filteredSongs.length;
            
            if (count === 0) {
                document.getElementById('songsContainer').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: #999;">Песни не найдены</div>';
                return;
            }
            
            // Группируем по латинским буквам
            const songsByLatinLetter = {};
            filteredSongs.forEach(song => {
                const latinLetter = song.letter || '?';
                if (!songsByLatinLetter[latinLetter]) {
                    songsByLatinLetter[latinLetter] = [];
                }
                songsByLatinLetter[latinLetter].push(song);
            });
            
            // Конвертируем в русские буквы и сортируем
            const songsByRussianLetter = {};
            const russianLetters = [];
            
            Object.keys(songsByLatinLetter).forEach(latinLetter => {
                const russianLetter = latinToRussian(latinLetter);
                songsByRussianLetter[russianLetter] = songsByLatinLetter[latinLetter];
                russianLetters.push(russianLetter);
            });
            
            // Сортируем буквы по русскому алфавиту
            russianLetters.sort((a, b) => {
                const indexA = RUSSIAN_ALPHABET.indexOf(a);
                const indexB = RUSSIAN_ALPHABET.indexOf(b);
                
                // Если буква не в алфавите, помещаем её в конец
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                
                return indexA - indexB;
            });
            
            // Создаём алфавитную навигацию
            createAlphaNav(russianLetters);
            
            // Отображаем песни по буквам
            const container = document.getElementById('songsContainer');
            container.innerHTML = '';
            
            russianLetters.forEach(russianLetter => {
                const group = document.createElement('div');
                group.className = 'letter-group';
                group.id = `letter-${russianLetter}`;
                
                // Заголовок группы
                const header = document.createElement('h2');
                header.textContent = russianLetter;
                header.style.marginBottom = '10px';
                header.style.color = '#2c3e50';
                group.appendChild(header);
                
                // Сортируем песни внутри группы
                const sortedSongs = songsByRussianLetter[russianLetter].sort((a, b) => 
                    a.title.localeCompare(b.title, 'ru')
                );
                
                // Добавляем песни
                sortedSongs.forEach(song => {
                    const link = document.createElement('a');
                    link.href = song.url;
                    link.textContent = song.title;
                    
                    // Добавляем мета-информацию
                    if (song.book || song.ton) {
                        const meta = document.createElement('span');
                        meta.style.color = '#666';
                        meta.style.fontSize = '0.85rem';
                        meta.style.marginLeft = '8px';
                        
                        let metaText = '';
                        if (song.book) {
                            metaText += ` (${song.book}${song.num || ''})`;
                        }
                        if (song.ton) {
                            metaText += ` [${song.ton}]`;
                        }
                        meta.textContent = metaText;
                        
                        link.appendChild(meta);
                    }
                    
                    group.appendChild(link);
                });
                
                container.appendChild(group);
            });
        }
        
        // Создание алфавитной навигации
        function createAlphaNav(letters) {
            const nav = document.getElementById('alphaNav');
            nav.innerHTML = '';
            
            letters.forEach(letter => {
                const link = document.createElement('a');
                link.href = `#letter-${letter}`;
                link.textContent = letter;
                nav.appendChild(link);
            });
        }
        
        // Загрузка данных при загрузке страницы
        loadData();
    </script>
</body>
</html>
