<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <title>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∞–∫–∫–æ—Ä–¥–æ–≤</title>
    <link rel="stylesheet" href="CSS/index.css">
    <style>
        /* –°—Ç—É–ø–µ–Ω–∏ - –≤–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .steps-panel {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .steps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px;
        }
        
        .step-btn {
            padding: 12px;
            background: #f0f8ff;
            border: 2px solid #3498db;
            border-radius: 6px;
            color: #3498db;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .step-btn:hover {
            background: #e0f0ff;
        }
        
        .step-btn.active {
            background: #3498db;
            color: white;
        }
        
        /* –°–ø–∏—Å–æ–∫ –∞–∫–∫–æ—Ä–¥–æ–≤ - —Å—Ä–µ–¥–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .chords-panel {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 80px;
            z-index: 90;
            display: none;
        }
        
        .chords-panel.show {
            display: block;
        }
        
        .chords-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
        }
        
        .chord-btn {
            padding: 10px 8px;
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 6px;
            color: #856404;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            white-space: nowrap;
        }
        
        .chord-btn:hover {
            background: #ffe69c;
        }
        
        .chord-btn.active {
            background: #ffc107;
            color: #000;
        }
        
        /* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫–∫–æ—Ä–¥–∞ - –Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .chord-display {
            background: white;
            border-radius: 8px;
            padding: 12px 10px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            display: none;
        }
        
        .chord-display.show {
            display: block;
        }
        
        .chord-name-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .chord-name {
            font-size: 2rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .play-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            opacity: 0.6;
            transition: opacity 0.2s, transform 0.1s;
        }

        .play-btn:hover {
            opacity: 1;
        }

        .play-btn.playing {
            opacity: 1;
            transform: scale(1.2);
        }
        
        .chord-description {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 10px;
        }
        
        .chord-image-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 8px 0;
        }
        
        .chord-image {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .empty-state {
            background: white;
            border-radius: 8px;
            padding: 60px 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .empty-state-text {
            font-size: 1.2rem;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 600px) {
            .steps-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .chords-grid {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            }
            
            .chord-name {
                font-size: 1.5rem;
            }
            
            .chord-description {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="header-nav">
            <a href="index.html" class="header-cell">–ê–ë–í</a>
            <a href="index_full.html" class="header-cell">–í—Å–µ</a>
            <a href="topics.html" class="header-cell">–¢–µ–º—ã</a>
            <a href="books.html" class="header-cell">–ö–Ω–∏–≥–∏</a>
            <a href="today.html" class="header-cell">–°–µ–≥–æ–¥–Ω—è</a>
            <a href="search.html" class="header-cell">
                <img src="search.png" alt="–ü–æ–∏—Å–∫">
            </a>
        </div>
        
        <!-- –ü–∞–Ω–µ–ª—å —Å—Ç—É–ø–µ–Ω–µ–π (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞) -->
        <div class="steps-panel">
            <div class="steps-grid" id="stepsGrid"></div>
        </div>
        
        <!-- –ü–∞–Ω–µ–ª—å –∞–∫–∫–æ—Ä–¥–æ–≤ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Å—Ç—É–ø–µ–Ω–∏) -->
        <div class="chords-panel" id="chordsPanel">
            <div class="chords-grid" id="chordsGrid"></div>
        </div>
        
        <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–∫–∫–æ—Ä–¥–∞ -->
        <div class="chord-display" id="chordDisplay">
            <div class="chord-name-row">
                <div class="chord-name" id="chordName"></div>
                <button class="play-btn" id="playBtn" title="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∞–∫–∫–æ—Ä–¥">üîä</button>
            </div>
            <div class="chord-description" id="chordDescription"></div>
            <div class="chord-image-container">
                <img class="chord-image" id="chordImage" alt="–ê–∫–∫–æ—Ä–¥">
            </div>
        </div>
        
        <!-- –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø—É—Å—Ç–æ) -->
        <div class="empty-state" id="emptyState">
            <div class="empty-state-icon">üéπ</div>
            <div class="empty-state-text">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–ø–µ–Ω—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∞–∫–∫–æ—Ä–¥—ã</div>
        </div>
    </div>

    <script>
        // –î–∞–Ω–Ω—ã–µ –∞–∫–∫–æ—Ä–¥–æ–≤ (–±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ JSON)
        let chordsData = null;
        let currentStep = null;
        let currentChord = null;
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        async function loadChordsData() {
            try {
                const response = await fetch('chords_data.json');
                if (!response.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–∫–∫–æ—Ä–¥–æ–≤');
                }
                chordsData = await response.json();
                initializeSteps();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                document.getElementById('emptyState').innerHTML = `
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <div class="empty-state-text">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–∫–∫–æ—Ä–¥–æ–≤.<br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.</div>
                `;
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–Ω–µ–ª–∏ —Å—Ç—É–ø–µ–Ω–µ–π
        function initializeSteps() {
            const stepsGrid = document.getElementById('stepsGrid');
            stepsGrid.innerHTML = '';
            
            chordsData.steps.forEach(step => {
                if (chordsData.chords[step] && chordsData.chords[step].length > 0) {
                    const btn = document.createElement('button');
                    btn.className = 'step-btn';
                    btn.textContent = step;
                    btn.onclick = () => selectStep(step);
                    stepsGrid.appendChild(btn);
                }
            });
        }
        
        // –í—ã–±–æ—Ä —Å—Ç—É–ø–µ–Ω–∏
        function selectStep(step) {
            currentStep = step;
            currentChord = null;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É —Å—Ç—É–ø–µ–Ω–∏
            document.querySelectorAll('.step-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === step);
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∞–∫–∫–æ—Ä–¥–æ–≤
            displayChords(step);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫–∫–æ—Ä–¥–∞
            document.getElementById('chordDisplay').classList.remove('show');
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('emptyState').innerHTML = `
                <div class="empty-state-icon">üéº</div>
                <div class="empty-state-text">–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–æ—Ä–¥ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ</div>
            `;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–∫–∫–æ—Ä–¥–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—É–ø–µ–Ω–∏
        function displayChords(step) {
            const chordsGrid = document.getElementById('chordsGrid');
            const chordsPanel = document.getElementById('chordsPanel');
            
            chordsGrid.innerHTML = '';
            
            const chords = chordsData.chords[step];
            chords.forEach(chord => {
                const btn = document.createElement('button');
                btn.className = 'chord-btn';
                btn.textContent = chord.name;
                btn.onclick = () => selectChord(chord);
                chordsGrid.appendChild(btn);
            });
            
            chordsPanel.classList.add('show');
        }
        
        // –í—ã–±–æ—Ä –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫–∫–æ—Ä–¥–∞
        function selectChord(chord) {
            currentChord = chord;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –∞–∫–∫–æ—Ä–¥–∞
            document.querySelectorAll('.chord-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === chord.name);
            });
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            document.getElementById('emptyState').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫–∫–æ—Ä–¥
            const chordDisplay = document.getElementById('chordDisplay');
            document.getElementById('chordName').textContent = chord.name;
            document.getElementById('chordDescription').textContent = chord.description;
            
            const img = document.getElementById('chordImage');
            img.src = chord.image;
            img.alt = `${chord.name} - ${chord.description}`;
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            img.onerror = function() {
                this.src = 'data:image/svg+xml,' + encodeURIComponent(`
                    <svg width="186" height="377" xmlns="http://www.w3.org/2000/svg">
                        <rect width="186" height="377" fill="#f0f0f0"/>
                        <text x="93" y="188" text-anchor="middle" font-family="Arial" font-size="16" fill="#999">
                            –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ<tspan x="93" dy="20">–Ω–µ –Ω–∞–π–¥–µ–Ω–æ</tspan>
                        </text>
                    </svg>
                `);
            };
            
            chordDisplay.classList.add('show');
        }
        

        // ‚îÄ‚îÄ –ê—É–¥–∏–æ (Salamander Grand Piano) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const SEMI = {C:0,'C#':1,'Db':1,D:2,'D#':3,'Eb':3,E:4,'E#':5,F:5,'F#':6,'Gb':6,G:7,'G#':8,'Ab':8,A:9,'A#':10,'Bb':10,B:11};
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const sampleBuffers = {};
        const BASE_URL = 'https://gleitz.github.io/midi-js-soundfonts/MusyngKite/acoustic_grand_piano-mp3/';

        // –ù–æ—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–∫–∫–æ—Ä–¥–∞ (H = B natural, B = Bb)
        const CHORD_NOTES = {
            'A':      ['A','C#','E'],
            'A6':     ['A','C#','E','F#'],
            'A7':     ['A','C#','E','G'],
            'A9':     ['A','C#','E','G','B'],
            'Am':     ['A','C','E'],
            'Am6':    ['A','C','E','F#'],
            'Am7':    ['A','C','E','G'],
            'Asus':   ['A','D','E'],
            'Asus7':  ['A','D','E','G'],
            'A#dim':  ['A#','C#','E','G'],
            'B':      ['Bb','D','F'],
            'B+5':    ['Bb','D','F#'],
            'B7':     ['Bb','D','F','A'],
            'B9':     ['Bb','D','F','A','C'],
            'Bm':     ['Bb','Db','F'],
            'Bm6':    ['Bb','Db','F','G'],
            'C':      ['C','E','G'],
            'C6':     ['C','E','G','A'],
            'C7':     ['C','E','G','Bb'],
            'C9':     ['C','E','G','Bb','D'],
            'Cm':     ['C','Eb','G'],
            'Cm6':    ['C','Eb','G','A'],
            'Cm7':    ['C','Eb','G','Bb'],
            'Cm-5':   ['C','Eb','Gb'],
            'Cmaj7':  ['C','E','G','B'],
            'C#7':    ['C#','F','G#','B'],
            'C#m':    ['C#','E','G#'],
            'C#m7':   ['C#','E','G#','B'],
            'C#dim':  ['C#','E','G','Bb'],
            'C#m-5':  ['C#','E','G'],
            'D':      ['D','F#','A'],
            'D+5':    ['D','F#','A#'],
            'D7':     ['D','F#','A','C'],
            'D-7':    ['D','F#','Ab','C'],
            'D-9':    ['D','F#','A','C','Eb'],
            'D76':    ['D','F#','A','B','C'],
            'Dm':     ['D','F','A'],
            'Dm6':    ['D','F','A','B'],
            'Dm7':    ['D','F','A','C'],
            'Dsus':   ['D','G','A'],
            'Dmaj7':  ['D','F#','A','C#'],
            'D#dim':  ['D#','F#','A','C'],
            'D#m-5':  ['D#','F#','A'],
            'E':      ['E','G#','B'],
            'E7':     ['E','G#','B','D'],
            'E-9':    ['E','G#','B','D','F'],
            'Em':     ['E','G','B'],
            'Em6':    ['E','G','B','C#'],
            'Em7':    ['E','G','B','D'],
            'Edim':   ['E','G','Bb','Db'],
            'Esus':   ['E','A','B'],
            'F':      ['F','A','C'],
            'F6':     ['F','A','C','D'],
            'F7':     ['F','A','C','Eb'],
            'F9':     ['F','A','C','Eb','G'],
            'Fm':     ['F','Ab','C'],
            'Fm6':    ['F','Ab','C','D'],
            'Fm7':    ['F','Ab','C','Eb'],
            'Fdim':   ['F','Ab','B','D'],
            'F#7':    ['F#','A#','C#','E'],
            'F#-9':   ['F#','A#','C#','E','G'],
            'F#m':    ['F#','A','C#'],
            'F#m7':   ['F#','A','C#','E'],
            'F#dim':  ['F#','A','C','Eb'],
            'F#m-5':  ['F#','A','C'],
            'F#sus':  ['F#','B','C#'],
            'G':      ['G','B','D'],
            'G6':     ['G','B','D','E'],
            'G7':     ['G','B','D','F'],
            'G9':     ['G','B','D','F','A'],
            'Gm':     ['G','Bb','D'],
            'Gm6':    ['G','Bb','D','E'],
            'Gm7':    ['G','Bb','D','F'],
            'Gsus':   ['G','C','D'],
            'Gsus7':  ['G','C','D','F'],
            'Gmaj7':  ['G','B','D','F#'],
            'G#m':    ['G#','B','D#'],
            'G#dim':  ['G#','B','D','F'],
            'G#m-5':  ['G#','B','D'],
            'H':      ['B','D#','F#'],
            'H+5':    ['B','D#','G'],
            'H7':     ['B','D#','F#','A'],
            'H9':     ['B','D#','F#','A','C#'],
            'Hm':     ['B','D','F#'],
            'Hm6':    ['B','D','F#','G#'],
            'Hm7':    ['B','D','F#','A'],
            'Hm-5':   ['B','D','F'],
            'Hsus':   ['B','E','F#'],
        };

        function noteToMidi(name, oct) {
            let acc = name.length > 1 ? name.slice(1) : '';
            const s = SEMI[name[0] + acc] ?? SEMI[name[0]] ?? 0;
            return (oct + 1) * 12 + s;
        }

        function midiToGleitz(midi) {
            const names = ['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];
            return names[midi % 12] + (Math.floor(midi / 12) - 1);
        }

        function assignOctaves(notes) {
            const result = [];
            let prev = -1, oct = 3;
            for (let i = 0; i < notes.length; i++) {
                let midi = noteToMidi(notes[i], oct);
                if (i > 0 && midi <= prev) { oct++; midi = noteToMidi(notes[i], oct); }
                result.push(midi);
                prev = midi;
            }
            return result;
        }

        async function ensureSample(midi) {
            if (sampleBuffers[midi]) return;
            const url = BASE_URL + midiToGleitz(midi) + '.mp3';
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(res.status);
                const arr = await res.arrayBuffer();
                sampleBuffers[midi] = await audioCtx.decodeAudioData(arr);
            } catch(e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—ç–º–ø–ª:', midiToGleitz(midi));
            }
        }

        function playMidi(midi, when, dur) {
            const buf = sampleBuffers[midi];
            if (!buf) return;
            const src = audioCtx.createBufferSource();
            src.buffer = buf;
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0.8, when);
            gain.gain.exponentialRampToValueAtTime(0.001, when + dur + 2);
            src.connect(gain);
            gain.connect(audioCtx.destination);
            src.start(when);
            src.stop(when + dur + 2.5);
        }

        let playBtn = null;
        document.addEventListener('DOMContentLoaded', () => {
            playBtn = document.getElementById('playBtn');
            playBtn.addEventListener('click', () => playCurrentChord());
        });

        async function playCurrentChord() {
            if (!currentChord) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const notes = CHORD_NOTES[currentChord.name];
            if (!notes) { console.warn('–ù–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è:', currentChord.name); return; }

            const midis = assignOctaves(notes);
            await Promise.all(midis.map(m => ensureSample(m)));

            const dur = 3.0;
            const arpDelay = 0.07;
            const now = audioCtx.currentTime + 0.05;

            playBtn.classList.add('playing');
            midis.forEach((midi, i) => playMidi(midi, now + i * arpDelay, dur));

            const total = (dur + midis.length * arpDelay) * 1000 + 500;
            setTimeout(() => playBtn.classList.remove('playing'), total);
        }
        // ‚îÄ‚îÄ –ö–æ–Ω–µ—Ü –∞—É–¥–∏–æ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', loadChordsData);
    </script>
</body>
</html>
